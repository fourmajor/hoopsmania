name: Security Vulnerability Scan

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  schedule:
    - cron: '0 17 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run pip-audit
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit
          pip-audit -r backend/requirements.txt -f json -o pip-audit-report.json || true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: |
          cd web
          npm install --ignore-scripts
          npm audit --audit-level=high --json > ../npm-audit-report.json || true

      - name: Summarize findings and enforce policy
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          pip_path = Path('pip-audit-report.json')
          npm_path = Path('npm-audit-report.json')

          # Temporary allowlist for vulnerabilities that currently have no compatible upstream fix.
          # Review monthly and remove once upstream dependencies ship a patch.
          ignored_vuln_ids = {
            'GHSA-7f5h-v6xp-fcq8',  # Starlette range parser DoS (FastAPI currently pins Starlette 0.48.x)
            'CVE-2025-62727',
          }

          pip_count = 0
          ignored_count = 0
          if pip_path.exists():
            try:
              data = json.loads(pip_path.read_text())
              deps = data.get('dependencies', [])
              for dep in deps:
                for vuln in dep.get('vulns', []):
                  vuln_ids = {vuln.get('id'), *vuln.get('aliases', [])}
                  if vuln_ids & ignored_vuln_ids:
                    ignored_count += 1
                    continue
                  pip_count += 1
            except Exception:
              pass

          npm_high = 0
          npm_critical = 0
          if npm_path.exists():
            try:
              data = json.loads(npm_path.read_text())
              meta = data.get('metadata', {}).get('vulnerabilities', {})
              npm_high = int(meta.get('high', 0))
              npm_critical = int(meta.get('critical', 0))
            except Exception:
              pass

          summary = (
            f"pip-audit vulnerabilities (actionable): {pip_count}\n"
            f"pip-audit vulnerabilities (temporarily ignored): {ignored_count}\n"
            f"npm high vulnerabilities: {npm_high}\n"
            f"npm critical vulnerabilities: {npm_critical}\n"
          )
          print(summary)

          with open('security-audit-summary.txt', 'w') as fh:
            fh.write(summary)

          # Policy: fail when any findings are present so the signal is visible and actionable.
          if pip_count > 0 or npm_high > 0 or npm_critical > 0:
            raise SystemExit(1)
          PY

      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            pip-audit-report.json
            npm-audit-report.json
            security-audit-summary.txt
